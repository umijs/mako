name: utoo-ci

on: [pull_request]

env:
  CARGO_INCREMENTAL: 1

jobs:
  detect-changes:
    runs-on: macos-latest
    outputs:
      changed-crates: ${{ steps.detect.outputs.changed-crates }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect changes
      id: detect
      run: |
        CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})

        CHANGED_CRATES=""
        for file in $CHANGED_FILES; do
          if [[ $file =~ ^crates/[^/]+/ ]]; then
            CRATE_DIR=$(echo $file | sed 's|^crates/\([^/]\+\)/.*|\1|')
            if [ -f "crates/$CRATE_DIR/Cargo.toml" ]; then
              PACKAGE_NAME=$(grep -m 1 '^name = ' "crates/$CRATE_DIR/Cargo.toml" | sed 's/name = "\(.*\)"/\1/')
              if [ -n "$PACKAGE_NAME" ]; then
                CHANGED_CRATES="$CHANGED_CRATES $PACKAGE_NAME"
              fi
            fi
          fi
        done
        CHANGED_CRATES=$(echo $CHANGED_CRATES | tr ' ' '\n' | sort -u | tr '\n' ' ')
        echo "changed-crates=$CHANGED_CRATES" >> $GITHUB_OUTPUT

  build:
    needs: detect-changes
    if: needs.detect-changes.outputs.changed-crates != ''
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: nightly-2025-02-12
        override: true
        components: rustfmt, clippy

    - name: Check formatting
      uses: actions-rs/cargo@v1
      with:
        command: fmt
        toolchain: nightly-2025-02-12
        args: --all -- --check

    - name: Build changed crates
      run: |
        for crate in ${{ needs.detect-changes.outputs.changed-crates }}; do
          echo "Building crate: $crate"
          cargo build -p $crate
        done

    - name: Test changed crates
      run: |
        for crate in ${{ needs.detect-changes.outputs.changed-crates }}; do
          echo "Testing crate: $crate"
          cargo test -p $crate
        done
